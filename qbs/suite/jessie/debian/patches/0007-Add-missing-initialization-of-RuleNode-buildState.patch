From 0199fd7a839e3c3899833092e4fa7b3f5ea89880 Mon Sep 17 00:00:00 2001
From: Christian Kandeler <christian.kandeler@theqtcompany.com>
Date: Wed, 1 Apr 2015 16:00:31 +0200
Subject: [PATCH 7/7] Add missing initialization of RuleNode::buildState.

Task-number: QBS-727
Change-Id: I04287df999aea1047debc5971cf3404041c20ec5
Reviewed-by: Joerg Bornemann <joerg.bornemann@theqtcompany.com>
---
 src/lib/corelib/buildgraph/artifact.cpp       | 1 -
 src/lib/corelib/buildgraph/buildgraphnode.cpp | 2 +-
 src/lib/corelib/buildgraph/executor.cpp       | 4 ++++
 3 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/src/lib/corelib/buildgraph/artifact.cpp b/src/lib/corelib/buildgraph/artifact.cpp
index 850fcd4..caf590f 100644
--- a/src/lib/corelib/buildgraph/artifact.cpp
+++ b/src/lib/corelib/buildgraph/artifact.cpp
@@ -110,7 +110,6 @@ void Artifact::setFileTags(const FileTags &newFileTags)
 void Artifact::initialize()
 {
     artifactType = Unknown;
-    buildState = Untouched;
     inputsScanned = false;
     timestampRetrieved = false;
     alwaysUpdated = true;
diff --git a/src/lib/corelib/buildgraph/buildgraphnode.cpp b/src/lib/corelib/buildgraph/buildgraphnode.cpp
index 4c8f101..f10801e 100644
--- a/src/lib/corelib/buildgraph/buildgraphnode.cpp
+++ b/src/lib/corelib/buildgraph/buildgraphnode.cpp
@@ -42,7 +42,7 @@
 namespace qbs {
 namespace Internal {
 
-BuildGraphNode::BuildGraphNode()
+BuildGraphNode::BuildGraphNode() : buildState(Untouched)
 {
 }
 
diff --git a/src/lib/corelib/buildgraph/executor.cpp b/src/lib/corelib/buildgraph/executor.cpp
index bcbbd2d..36d7b01 100644
--- a/src/lib/corelib/buildgraph/executor.cpp
+++ b/src/lib/corelib/buildgraph/executor.cpp
@@ -961,12 +961,16 @@ void Executor::checkForCancellation()
 
 bool Executor::visit(Artifact *artifact)
 {
+    QBS_CHECK(artifact->buildState != BuildGraphNode::Untouched);
+    QBS_CHECK(m_productsToBuild.contains(artifact->product));
     buildArtifact(artifact);
     return false;
 }
 
 bool Executor::visit(RuleNode *ruleNode)
 {
+    QBS_CHECK(ruleNode->buildState != BuildGraphNode::Untouched);
+    QBS_CHECK(m_productsToBuild.contains(ruleNode->product));
     executeRuleNode(ruleNode);
     return false;
 }
-- 
2.1.4

